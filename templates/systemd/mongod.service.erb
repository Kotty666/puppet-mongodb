[Unit]
Description=Mongos_<%= @mongod_instance %> server
Wants=network.target
After=network.target

[Service]
Type=forking
PIDFile=<%= scope.lookupvar('mongodb::pidfilepath') %>/mongod_<%= @mongod_instance %>/mongod.pid
ExecStart=/usr/bin/mongod --config /etc/mongod_<%= @mongod_instance %>.conf
Restart=on-failure
User=<%= scope.lookupvar('mongodb::run_as_user') %>
Group=<%= scope.lookupvar('mongodb::run_as_group') %>
LimitNOFILE=<%= scope.lookupvar('mongodb::ulimit_nofiles') %>
LimitNPROC=<%= scope.lookupvar('mongodb::ulimit_nproc') %>
<% if @mongod_deactivate_transparent_hugepage -%>
<%# implement mdiag.sh best-practice %>
ExecStartPre=/bin/bash -c 'test -f /sys/kernel/mm/transparent_hugepage/khugepaged/defrag && echo 0 > /sys/kernel/mm/transparent_hugepage/khugepaged/defrag'
ExecStartPre=/bin/bash -c 'test -f /sys/kernel/mm/transparent_hugepage/defrag && echo never > /sys/kernel/mm/transparent_hugepage/defrag'
ExecStartPre=/bin/bash -c 'test -f /sys/kernel/mm/transparent_hugepage/enabled && echo never > /sys/kernel/mm/transparent_hugepage/enabled'
<% end -%>

[Install]
WantedBy=multi-user.target
